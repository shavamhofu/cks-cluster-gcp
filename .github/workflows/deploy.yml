name: Deploy CKS Cluster

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "$VM_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
      env:
        VM_SSH_PRIVATE_KEY: ${{ secrets.VM_SSH_PRIVATE_KEY }}  

    - name: Terraform Init & Apply
      run: |
        cd terraform
        terraform init
        # TF_LOG=DEBUG terraform apply -auto-approve
        terraform apply -auto-approve

    # - name: List Terraform files
    #   run: ls -l

    # - name: Terraform Destroy
    #   run: |
    #     terraform init
    #     terraform destroy -auto-approve

      env:
        GOOGLE_CREDENTIALS: ${{secrets.GCP_CREDENTIALS}}

    - name: Install Ansible
      run: sudo apt-get install -y ansible

    - name: Run Ansible Playbooks
      run: |
        cd ansible
        ansible-playbook -i inventory.ini master.yml
        ansible-playbook -i inventory.ini worker.yml
